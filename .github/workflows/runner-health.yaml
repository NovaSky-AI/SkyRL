name: Runner Health Check

on:
  schedule:
    # Run every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  check-runners:
    name: Check Runner Status
    runs-on: ubuntu-latest
    steps:
      - name: Check EC2 instance health
        id: ec2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1
        run: |
          # Runner instance IDs and names (from docs/gha-runner-setup.md)
          declare -A RUNNER_NAMES=(
            ["i-04a15158610df980f"]="fleet-runner-1"
            ["i-0f80c703294413a4c"]="fleet-runner-2"
            ["i-09321b67952c1a208"]="fleet-runner-3"
            ["i-0f2ccaa840ef29450"]="fleet-runner-4"
            ["i-05ecd98e74949dc87"]="fleet-runner-5"
          )

          echo "## EC2 Runner Health" >> $GITHUB_STEP_SUMMARY
          echo "| Runner | Instance | State | Health |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|-------|--------|" >> $GITHUB_STEP_SUMMARY

          UNHEALTHY=""
          UNHEALTHY_NAMES=""
          TOTAL=0
          HEALTHY=0

          for id in "${!RUNNER_NAMES[@]}"; do
            TOTAL=$((TOTAL + 1))
            NAME="${RUNNER_NAMES[$id]}"

            # Get instance state and status
            RESULT=$(aws ec2 describe-instance-status --instance-ids $id --include-all-instances \
              --query 'InstanceStatuses[0].[InstanceState.Name,InstanceStatus.Status]' --output text 2>/dev/null)

            if [ -z "$RESULT" ] || [ "$RESULT" = "None" ]; then
              STATE="unknown"
              HEALTH="unknown"
            else
              STATE=$(echo $RESULT | awk '{print $1}')
              HEALTH=$(echo $RESULT | awk '{print $2}')
            fi

            # Check if healthy (running + ok)
            if [ "$STATE" = "running" ] && [ "$HEALTH" = "ok" ]; then
              HEALTHY=$((HEALTHY + 1))
              echo "| $NAME | $id | âœ… $STATE | $HEALTH |" >> $GITHUB_STEP_SUMMARY
            else
              UNHEALTHY="$UNHEALTHY $id"
              UNHEALTHY_NAMES="$UNHEALTHY_NAMES $NAME"
              echo "| $NAME | $id | âŒ $STATE | $HEALTH |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Summary:** $HEALTHY/$TOTAL healthy" >> $GITHUB_STEP_SUMMARY

          # Export for alert step
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "healthy=$HEALTHY" >> $GITHUB_OUTPUT
          echo "unhealthy_count=$((TOTAL - HEALTHY))" >> $GITHUB_OUTPUT
          echo "unhealthy_ids=$(echo $UNHEALTHY | xargs)" >> $GITHUB_OUTPUT
          echo "unhealthy_names=$(echo $UNHEALTHY_NAMES | xargs)" >> $GITHUB_OUTPUT

      - name: Check queued jobs
        id: queue
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          QUEUED=$(gh run list --repo ${{ github.repository }} --status queued --json databaseId --jq 'length' 2>/dev/null || echo "0")
          IN_PROGRESS=$(gh run list --repo ${{ github.repository }} --status in_progress --json databaseId --jq 'length' 2>/dev/null || echo "0")

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Jobs:** $QUEUED queued, $IN_PROGRESS in progress" >> $GITHUB_STEP_SUMMARY

          echo "queued=$QUEUED" >> $GITHUB_OUTPUT
          echo "in_progress=$IN_PROGRESS" >> $GITHUB_OUTPUT

      - name: Alert on issues
        if: steps.ec2.outputs.unhealthy_count != '0'
        uses: slackapi/slack-github-action@v2.0.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "#fleet-training-runs",
              "text": "ðŸš¨ Runner Health Alert",
              "blocks": [
                {
                  "type": "header",
                  "text": { "type": "plain_text", "text": "ðŸš¨ Runner(s) Unhealthy" }
                },
                {
                  "type": "section",
                  "fields": [
                    { "type": "mrkdwn", "text": "*Healthy:*\n${{ steps.ec2.outputs.healthy }}/${{ steps.ec2.outputs.total }}" },
                    { "type": "mrkdwn", "text": "*Unhealthy:*\n${{ steps.ec2.outputs.unhealthy_names }}" }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "To fix: `aws ec2 reboot-instances --instance-ids ${{ steps.ec2.outputs.unhealthy_ids }}`\nOr SSH in and restart: `sudo systemctl restart actions.runner.fleet-ai-SkyRL.*`"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    { "type": "mrkdwn", "text": "<https://github.com/${{ github.repository }}/settings/actions/runners|Manage Runners> | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Check>" }
                  ]
                }
              ]
            }

      - name: Fail if runners unhealthy
        if: steps.ec2.outputs.unhealthy_count != '0'
        run: |
          echo "::error::${{ steps.ec2.outputs.unhealthy_count }} runner(s) unhealthy: ${{ steps.ec2.outputs.unhealthy_names }}"
          exit 1
